name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install proto
        run: |
          curl -fsSL https://moonrepo.dev/install/proto.sh | bash
          echo "$HOME/.proto/shims" >> $GITHUB_PATH
          echo "$HOME/.proto/bin" >> $GITHUB_PATH

      - name: Setup tools
        run: proto use

      - name: Install dependencies
        run: |
          pnpm install
          cd native && pnpm install

      - name: Run tests
        run: |
          pnpm typecheck
          pnpm lint
          pnpm test

      - name: Build and package
        env:
          # 如果配置了签名，取消下面的注释
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # CSC_LINK: ${{ secrets.CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}

          # 未配置签名时禁用自动发现
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: pnpm build && electron-builder --mac --config --publish never

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          name: xToolbox v${{ steps.version.outputs.version }}
          body: |
            ## 安装方式

            ### Homebrew（推荐）
            ```bash
            brew install --cask rainx/tap/xtoolbox
            ```

            ### 直接下载
            | 架构 | DMG | ZIP |
            |------|-----|-----|
            | Apple Silicon | `xToolbox-${{ steps.version.outputs.version }}-mac-arm64.dmg` | `xToolbox-${{ steps.version.outputs.version }}-mac-arm64.zip` |
            | Intel | `xToolbox-${{ steps.version.outputs.version }}-mac-x64.dmg` | `xToolbox-${{ steps.version.outputs.version }}-mac-x64.zip` |

            > 首次打开未签名版本：右键点击应用 → 选择「打开」

            ---
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ steps.version.outputs.version }}
          path: dist/*.{dmg,zip}
          retention-days: 30

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        if: env.HOMEBREW_TAP_TOKEN != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA_ARM64=$(shasum -a 256 dist/xToolbox-${VERSION}-mac-arm64.zip | awk '{print $1}')
          SHA_X64=$(shasum -a 256 dist/xToolbox-${VERSION}-mac-x64.zip | awk '{print $1}')

          cat > /tmp/xtoolbox.rb <<EOF
          cask "xtoolbox" do
            version "${VERSION}"

            if Hardware::CPU.intel?
              sha256 "${SHA_X64}"
              url "https://github.com/rainx/xplayground/releases/download/v#{version}/xToolbox-#{version}-mac-x64.zip"
            else
              sha256 "${SHA_ARM64}"
              url "https://github.com/rainx/xplayground/releases/download/v#{version}/xToolbox-#{version}-mac-arm64.zip"
            end

            name "xToolbox"
            desc "Personal Mac toolbox - clone useful features from paid apps"
            homepage "https://github.com/rainx/xplayground"

            livecheck do
              url :url
              strategy :github_latest
            end

            app "xToolbox.app"

            postflight do
              # Remove quarantine attribute to avoid "damaged app" warning
              system_command "/usr/bin/xattr",
                             args: ["-cr", "#{appdir}/xToolbox.app"]
            end

            zap trash: [
              "~/Library/Application Support/xtoolbox",
              "~/Library/Preferences/com.rainx.xtoolbox.plist",
              "~/Library/Logs/xtoolbox",
            ]
          end
          EOF

          # Remove leading whitespace from heredoc
          sed -i '' 's/^          //' /tmp/xtoolbox.rb

          # Clone homebrew-tap repo and update
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/rainx/homebrew-tap.git" /tmp/homebrew-tap
          cp /tmp/xtoolbox.rb /tmp/homebrew-tap/Casks/xtoolbox.rb
          cd /tmp/homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/xtoolbox.rb
          git diff --cached --quiet && echo "No changes to Homebrew formula" && exit 0
          git commit -m "Update xtoolbox to v${VERSION}"
          git push
